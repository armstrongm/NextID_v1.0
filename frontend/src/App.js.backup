import React, { useState, useEffect } from 'react';
import { Search, Plus, Settings, Users, Shield, Link, Trash2, Edit, Eye, CheckCircle, XCircle, RefreshCw, LayoutDashboard, LogOut, Menu, X, Activity, TrendingUp } from 'lucide-react';
import { authAPI, usersAPI, groupsAPI } from './services/api';

const IAMApp = () => {
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [currentUser, setCurrentUser] = useState(null);
  const [showRegister, setShowRegister] = useState(false);
  const [sidebarOpen, setSidebarOpen] = useState(true);
  const [currentView, setCurrentView] = useState('dashboard');
  const [users, setUsers] = useState([]);
  const [groups, setGroups] = useState([]);
  const [stats, setStats] = useState({ total: 0, provisioned: 0, groups: 0 });
  const [loading, setLoading] = useState(false);
  const [showModal, setShowModal] = useState(false);
  const [modalType, setModalType] = useState('');
  const [selectedItem, setSelectedItem] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [loginForm, setLoginForm] = useState({ username: '', password: '' });
  const [registerForm, setRegisterForm] = useState({ username: '', password: '', email: '', confirmPassword: '' });
  const [formData, setFormData] = useState({});
  const [loginError, setLoginError] = useState('');
  const [pagination, setPagination] = useState({ page: 0, size: 20, totalPages: 0 });

  // Check if user is already logged in
  useEffect(() => {
    const token = localStorage.getItem('token');
    const user = localStorage.getItem('user');
    
    if (token && user) {
      setIsAuthenticated(true);
      setCurrentUser(JSON.parse(user));
    }
  }, []);

  // Load data when authenticated
  useEffect(() => {
    if (isAuthenticated) {
      loadDashboardData();
    }
  }, [isAuthenticated]);

  // Load users when view changes
  useEffect(() => {
    if (isAuthenticated && currentView === 'users') {
      loadUsers();
    }
  }, [isAuthenticated, currentView, searchTerm, pagination.page]);

  // Load groups when view changes
  useEffect(() => {
    if (isAuthenticated && currentView === 'groups') {
      loadGroups();
    }
  }, [isAuthenticated, currentView, searchTerm]);

  const loadDashboardData = async () => {
    try {
      const [userStatsRes, groupStatsRes] = await Promise.all([
        usersAPI.getStats(),
        groupsAPI.getStats()
      ]);

      setStats({
        total: userStatsRes.data.total,
        provisioned: userStatsRes.data.provisioned,
        groups: groupStatsRes.data.total
      });
    } catch (error) {
      console.error('Error loading dashboard data:', error);
    }
  };

  const loadUsers = async () => {
    setLoading(true);
    try {
      const response = await usersAPI.getAll({
        page: pagination.page,
        size: pagination.size,
        search: searchTerm
      });

      setUsers(response.data.content);
      setPagination(prev => ({
        ...prev,
        totalPages: response.data.totalPages
      }));
    } catch (error) {
      console.error('Error loading users:', error);
      alert('Failed to load users');
    } finally {
      setLoading(false);
    }
  };

  const loadGroups = async () => {
    setLoading(true);
    try {
      const response = await groupsAPI.getAll({
        search: searchTerm
      });

      setGroups(response.data.content);
    } catch (error) {
      console.error('Error loading groups:', error);
      alert('Failed to load groups');
    } finally {
      setLoading(false);
    }
  };

  const handleLogin = async () => {
    setLoading(true);
    setLoginError('');
    
    try {
      const response = await authAPI.login(loginForm);
      const { token, username, email, role } = response.data;

      localStorage.setItem('token', token);
      localStorage.setItem('user', JSON.stringify({ username, email, role }));

      setIsAuthenticated(true);
      setCurrentUser({ username, email, role });
      setCurrentView('dashboard');
    } catch (error) {
      setLoginError(error.response?.data?.error || 'Login failed');
    } finally {
      setLoading(false);
    }
  };

  const handleRegister = async () => {
    if (registerForm.password !== registerForm.confirmPassword) {
      setLoginError('Passwords do not match');
      return;
    }

    setLoading(true);
    setLoginError('');

    try {
      const response = await authAPI.register({
        username: registerForm.username,
        email: registerForm.email,
        password: registerForm.password
      });

      const { token, username, email, role } = response.data;

      localStorage.setItem('token', token);
      localStorage.setItem('user', JSON.stringify({ username, email, role }));

      setIsAuthenticated(true);
      setCurrentUser({ username, email, role });
      setCurrentView('dashboard');
    } catch (error) {
      setLoginError(error.response?.data?.error || 'Registration failed');
    } finally {
      setLoading(false);
    }
  };

  const handleLogout = () => {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    setIsAuthenticated(false);
    setCurrentUser(null);
    setLoginForm({ username: '', password: '' });
  };

  const handleSaveUser = async () => {
    setLoading(true);
    try {
      if (selectedItem) {
        await usersAPI.update(selectedItem.id, formData);
        alert('User updated successfully');
      } else {
        await usersAPI.create(formData);
        alert('User created successfully');
      }
      closeModal();
      loadUsers();
      loadDashboardData();
    } catch (error) {
      alert(error.response?.data?.error || 'Failed to save user');
    } finally {
      setLoading(false);
    }
  };

  const handleDeleteUser = async (id) => {
    if (!window.confirm('Are you sure you want to delete this user?')) {
      return;
    }

    setLoading(true);
    try {
      await usersAPI.delete(id);
      alert('User deleted successfully');
      loadUsers();
      loadDashboardData();
    } catch (error) {
      alert(error.response?.data?.error || 'Failed to delete user');
    } finally {
      setLoading(false);
    }
  };

  const handleSaveGroup = async () => {
    setLoading(true);
    try {
      if (selectedItem) {
        await groupsAPI.update(selectedItem.id, formData);
        alert('Group updated successfully');
      } else {
        await groupsAPI.create(formData);
        alert('Group created successfully');
      }
      closeModal();
      loadGroups();
      loadDashboardData();
    } catch (error) {
      alert(error.response?.data?.error || 'Failed to save group');
    } finally {
      setLoading(false);
    }
  };

  const handleDeleteGroup = async (id) => {
    if (!window.confirm('Are you sure you want to delete this group?')) {
      return;
    }

    setLoading(true);
    try {
      await groupsAPI.delete(id);
      alert('Group deleted successfully');
      loadGroups();
      loadDashboardData();
    } catch (error) {
      alert(error.response?.data?.error || 'Failed to delete group');
    } finally {
      setLoading(false);
    }
  };

  const openModal = (type, item = null) => {
    setModalType(type);
    setSelectedItem(item);
    setFormData(item || {});
    setShowModal(true);
  };

  const closeModal = () => {
    setShowModal(false);
    setModalType('');
    setSelectedItem(null);
    setFormData({});
  };